{{&descriptor}}
/** Asserts:
 *      'st->valid' is TRUE.
 *          The structure is initialized
 *      st->current_state == [state]
 *          Function are called from the right state      
 */
#include "{{filename}}.h"
#include <assert.h>

{{~#if constants}}
/* constants variables */
{{~#each constants}}{{!-- {{keyword static may be applied with respect to MISRA 1998 rule (Rule 23, advisory)}} --}}
const {{type}} {{name}}{{#if value}} = {{&value}}{{/if}};{{/each}}
{{~/if}}
{{#if transitions}}
/* declaration of helper functions */
void enter(state newStateLabel, struct_state *st) {
    assert( st->valid );
    st->current_state = newStateLabel;
}

void leave(state currentStateLabel, struct_state *st) {
    assert( st->valid );
    st->previous_state = currentStateLabel;
}{{/if}}
{{#if initial_transitions}}
/* initialisation function for model */
{{#each initial_transitions}}struct_state init{{&init_suffix}}(struct_state *st){
    st->valid = true;
    enter({{target.name}}, st);
    {{#each ../local_variables}}{{#if value}}st->{{name}} = {{&value}};{{/if}}
    {{/each}}
    {{~#each actions}}
    {{&.}};{{/each}}
    return *st;
}
{{/each}}{{/if}}
{{#if transitions}}
/* function declarations */
{{#each transitions}}{{#if id}}struct_state {{id}}(struct_state *st) {
    assert( st->valid && st->current_state == {{source.name}}); 
{{~#if condition}}
    if ({{&condition}}) {
        leave({{source.name}}, st);
        {{~#each actions}}
        {{&.}};{{/each}}
        enter({{target.name}}, st);
    }
{{~else}}
    leave({{source.name}}, st);
    {{~#each actions}}
    {{&.}};{{~/each}}
    enter({{target.name}}, st);
{{~/if}}
    return *st;
}
{{else}}struct_state {{0.id}}(struct_state *st) {
    assert( st->valid );
{{#each .}}
{{~#if condition}}
    if ({{&condition}} && st->current_state == {{source.name}}) {
        leave({{source.name}}, st);
        {{~#each actions}}
        {{&.}};{{/each}}
        enter({{target.name}}, st);
    }{{~else}}
    if (current_state == {{source.name}}) {
        leave({{source.name}}, st);
        {{~#each actions}}
        {{&.}};{{~/each}}
        enter({{target.name}}, st);
{{~/if}}{{/each}}
    return *st;
}
{{/if}}
{{/each}}{{/if}}
{{&disclaimer}}
